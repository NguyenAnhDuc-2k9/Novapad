name: Build and Release

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    name: Build & Package (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Rust Cache
      uses: swatinem/rust-cache@v2

    - name: Install NSIS
      run: choco install nsis

    - name: Install WiX Toolset
      run: choco install wixtoolset

    - name: Cache cargo-packager
      id: cache-cargo-packager
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/cargo-packager.exe
          ~/.cargo/.crates.toml
          ~/.cargo/.crates2.json
        key: ${{ runner.os }}-cargo-packager-locked

    - name: Install cargo-packager
      if: steps.cache-cargo-packager.outputs.cache-hit != 'true'
      run: cargo install cargo-packager --locked

    - name: Build (Release)
      run: cargo build --verbose --release

    - name: Package Application
      run: cargo packager --release

    - name: List target directory (Debug)
      shell: powershell
      run: Get-ChildItem -Path target/release -Recurse

    - name: Prepare Portable Artifact
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "staging"
        Copy-Item "target/release/novapad.exe" -Destination "staging/"

    - name: Upload Portable (Exe)
      uses: actions/upload-artifact@v4
      with:
        name: Novapad-Portable-Windows
        path: staging/

    - name: Upload Installers
      uses: actions/upload-artifact@v4
      with:
        name: Novapad-Installers
        path: |
          target/release/**/*.msi
          target/release/**/*.exe
          !target/release/novapad.exe
          !target/release/deps/**
          !target/release/build/**
          !target/release/incremental/**
