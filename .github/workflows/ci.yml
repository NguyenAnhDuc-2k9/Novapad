name: Build and Release

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    name: Build & Package (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Rust Cache
      uses: swatinem/rust-cache@v2

    - name: Format check
      run: cargo fmt --check

    - name: Clippy (advisory)
      run: cargo clippy --all

    - name: Tests
      run: cargo test --all

    - name: Install NSIS
      run: choco install nsis

    - name: Install WiX Toolset
      run: choco install wixtoolset

    - name: Cache cargo-packager
      id: cache-cargo-packager
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/cargo-packager.exe
          ~/.cargo/.crates.toml
          ~/.cargo/.crates2.json
        key: ${{ runner.os }}-cargo-packager-locked

    - name: Install cargo-packager
      if: steps.cache-cargo-packager.outputs.cache-hit != 'true'
      run: cargo install cargo-packager --locked

    - name: Build (Release)
      run: cargo build --verbose --release

    - name: Package Application (NSIS)
      run: cargo packager --release --formats nsis

    - name: Generate WiX Artifacts
      run: cargo packager --release --formats wix || cmd /c "exit /b 0"

    - name: Package Application (MSI)
      shell: powershell
      run: .\scripts\build_msi.ps1

    - name: List target directory (Debug)
      shell: powershell
      run: Get-ChildItem -Path target/release -Recurse

    - name: Upload Portable (Exe)
      uses: actions/upload-artifact@v4
      with:
        name: Novapad-Portable
        path: target/release/novapad.exe

    - name: Upload Installer (Setup)
      uses: actions/upload-artifact@v4
      with:
        name: Novapad-Setup
        path: target/release/*-setup.exe

    - name: Upload Installer (MSI)
      uses: actions/upload-artifact@v4
      with:
        name: Novapad-MSI
        path: target/release/*.msi
